<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¹ã‚±å¯¾æˆ¦è¡¨ãƒ¡ãƒ¼ã‚«ãƒ¼ (å¯©åˆ¤å®Œå…¨å¹³å‡åŒ–ç‰ˆ)</title>
    <style>
        :root {
            /* Screen Colors */
            --primary: #f97316; /* Orange 500 */
            --primary-dark: #c2410c; /* Orange 700 */
            --secondary: #1e293b; /* Slate 800 */
            --accent: #facc15; /* Yellow 400 */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #334155;
            --border: #cbd5e1;
        }

        * { box-sizing: border-box; }
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 40px;
            line-height: 1.4;
        }

        /* --- UI Components (Screen) --- */
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            background-image: linear-gradient(45deg, #f97316 25%, #ea580c 25%, #ea580c 50%, #f97316 50%, #f97316 75%, #ea580c 75%, #ea580c 100%);
            background-size: 20px 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 900;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
            font-style: italic;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-top: 24px;
        }
        @media (min-width: 1024px) {
            .main-content { flex-direction: row; }
            .settings-panel { width: 300px; flex-shrink: 0; }
            .preview-panel { flex-grow: 1; overflow-x: auto; }
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 16px;
            color: var(--secondary);
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 8px;
        }
        .icon-orange { color: var(--primary); }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: bold;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }
        .row { display: flex; gap: 12px; margin-bottom: 12px; }
        .col { flex: 1; }
        
        button {
            cursor: pointer;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            width: 100%;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.3);
        }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-1px); }
        .btn-outline {
            background: transparent;
            border: 2px dashed #cbd5e1;
            color: #64748b;
            width: 100%;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-weight: bold;
        }
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background-color: #fff7ed;
        }
        .btn-print {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 50px;
            backdrop-filter: blur(4px);
        }
        .btn-print:hover { background: rgba(255,255,255,0.3); }

        .team-item { display: flex; gap: 8px; margin-bottom: 8px; }
        .team-num {
            width: 32px; height: 38px; display: flex; align-items: center; justify-content: center;
            background: #f1f5f9; color: #64748b; font-size: 0.9rem; font-weight: bold; border-radius: 6px;
        }
        .btn-icon { background: transparent; color: #94a3b8; padding: 0 8px; display: flex; align-items: center; }
        .btn-icon:hover { color: #ef4444; }
        .btn-icon:disabled { opacity: 0.3; cursor: not-allowed; }

        .tab-switch { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-bottom: 16px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 0.85rem; text-align: center; border-radius: 6px; color: #64748b; font-weight: bold; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* --- Schedule Table (Screen) --- */
        .schedule-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            font-size: 0.9rem; 
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .schedule-table th, .schedule-table td { 
            padding: 8px; 
            border-left: 1px solid var(--border);
            border-top: 1px solid var(--border);
            vertical-align: middle; 
        }
        .schedule-table th { background: #f1f5f9; text-align: center; font-weight: bold; color: #334155; }
        
        .header-inner { display: grid; grid-template-columns: 1fr 60px 60px; height: 100%; align-items: center; }
        .header-part { padding: 4px; display: flex; align-items: center; justify-content: center; height: 100%; }
        .header-border-left { border-left: 1px solid var(--border); }
        .header-title-box { display: flex; flex-direction: column; line-height: 1.2; }
        .court-label { font-size: 0.85rem; }
        .court-sub { font-size: 0.7rem; font-weight: normal; color: #64748b; }

        .match-cell { 
            display: grid;
            grid-template-columns: 1fr 60px 60px;
            gap: 0;
            background: #fff; 
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .cell-part {
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.85rem;
        }
        .part-teams { font-weight: bold; background: linear-gradient(to bottom, #fff, #fff7ed); color: #334155; justify-content: center; gap: 8px; }
        .part-ref { border-left: 1px solid #cbd5e1; background: #f8fafc; color: #475569; font-size: 0.75rem; flex-direction: column; line-height: 1.1; }
        .part-both { border-left: 1px solid #cbd5e1; background: #eff6ff; color: #1e40af; font-weight: bold; font-size: 0.75rem; flex-direction: column; line-height: 1.1; }
        
        .vs-badge { font-size: 0.7rem; color: #fff; background: #cbd5e1; border-radius: 12px; padding: 1px 6px; font-weight: bold; margin: 0 4px; }

        /* --- Matrix Table --- */
        .matrix-container { overflow-x: auto; margin-top: 8px; border-radius: 8px; border: 1px solid var(--border); }
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .matrix-table th, .matrix-table td { border: 1px solid #cbd5e1; padding: 6px 8px; text-align: center; white-space: nowrap; }
        .matrix-table th { background: #f1f5f9; color: #334155; font-weight: bold; }
        .matrix-table th.matrix-team-col { position: sticky; left: 0; background: #f1f5f9; z-index: 1; text-align: left; min-width: 100px; border-right: 2px solid #cbd5e1; }
        .matrix-table td.matrix-team-col { position: sticky; left: 0; background: #fff; z-index: 1; text-align: left; font-weight: bold; color: #1e293b; border-right: 2px solid #cbd5e1; }
        
        .symbol-game { display: inline-block; background: #fff7ed; color: #ea580c; font-weight: 900; padding: 2px 8px; border-radius: 4px; border: 1px solid #fed7aa; }
        .symbol-ref { display: inline-block; background: #eff6ff; color: #2563eb; font-weight: 900; padding: 2px 8px; border-radius: 4px; border: 1px solid #bfdbfe; }
        .symbol-both { display: inline-block; background: #f3e8ff; color: #9333ea; font-weight: 900; padding: 2px 8px; border-radius: 4px; border: 1px solid #e9d5ff; }
        .matrix-legend { display: flex; gap: 12px; margin-top: 8px; font-size: 0.8rem; color: #64748b; justify-content: flex-end; }
        .legend-item { display: flex; align-items: center; gap: 6px; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; border: 2px dashed #e2e8f0; border-radius: 12px; background: #f8fafc; }
        .hidden { display: none; }
        .mt-4 { margin-top: 16px; } .mb-2 { margin-bottom: 8px; }
        svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-lg { width: 48px; height: 48px; stroke-width: 1.5; }
        .icon-sm { width: 14px; height: 14px; }

        /* --- PRINT STYLES (Colorful & Stylish) --- */
        @media print {
            @page { margin: 10mm; size: portrait; }
            
            body { 
                background: white; padding: 0; width: 100%;
                font-family: "Helvetica Neue", "Arial", sans-serif;
                font-size: 8.5pt; 
                -webkit-print-color-adjust: exact;
                color: #111;
            }
            
            header, .settings-panel, .no-print { display: none !important; }
            .container { max-width: 100%; padding: 0; margin: 0; }
            .main-content { margin: 0; display: block; }
            .card { border: none; box-shadow: none; padding: 0; margin: 0; }
            
            /* --- Stylish Header --- */
            .preview-header { 
                margin-bottom: 8px; 
                border-bottom: 4px solid #ea580c; /* Orange Accent */
                padding-bottom: 6px;
                display: flex; 
                justify-content: space-between; 
                align-items: flex-end;
            }
            .preview-header h1 { 
                font-size: 2rem !important; 
                margin: 0; 
                line-height: 1; 
                font-weight: 900;
                text-transform: uppercase;
                letter-spacing: -0.5px;
                color: #ea580c; /* Title Orange */
                font-style: italic;
                text-shadow: 1px 1px 0 #ddd;
            }
            .preview-header div { 
                font-size: 0.85rem !important; 
                font-weight: bold;
                font-family: monospace;
                display: flex;
                gap: 12px !important; 
                background: #f1f5f9;
                padding: 4px 10px;
                border-radius: 4px;
                color: #334155;
            }

            /* --- Table Styles --- */
            .schedule-table, .matrix-table { 
                width: 100%; 
                margin-bottom: 8px; 
                border-collapse: collapse; 
                border: 2px solid #334155; /* Dark Border */
            }
            
            /* Header Row */
            .schedule-table th, .matrix-table th { 
                background-color: #1e293b !important; /* Navy Header */
                color: #fff !important; 
                font-size: 0.8rem; 
                font-weight: 700;
                border: 1px solid #334155 !important;
                padding: 0 !important; 
                text-transform: uppercase;
            }
            
            .schedule-table td, .matrix-table td {
                border: 1px solid #94a3b8 !important; 
                padding: 0 !important;
            }

            /* --- Header Grid Structure --- */
            .header-inner {
                display: grid;
                grid-template-columns: 1fr 65px 65px; 
                width: 100%;
                height: 100%;
                margin: 0;
            }
            .header-part {
                padding: 4px 2px;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
                line-height: 1.1;
            }
            .header-border-left { 
                border-left: 1px solid #64748b !important; 
            }
            .header-title-box {
                justify-content: center; 
            }

            /* Match Cell */
            .match-cell {
                display: grid;
                grid-template-columns: 1fr 65px 65px; 
                border: none !important;
                background: transparent;
                border-radius: 0;
                align-items: stretch;
                min-height: 24px; 
            }
            .cell-part {
                padding: 3px 2px;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                justify-content: center;
                border: none;
                white-space: nowrap;
                overflow: hidden;
            }
            
            /* Colored Sections in Cells */
            .part-teams { 
                background: #fff7ed !important; 
                justify-content: center !important;
                gap: 6px;
                font-weight: 800;
                font-size: 0.95rem;
                color: #000 !important;
                display: grid !important;
                grid-template-columns: 1fr auto 1fr !important;
                padding: 0 4px !important;
            }
            .part-teams > span:nth-child(1) { text-align: right; overflow: hidden; text-overflow: ellipsis; }
            .part-teams > span:nth-child(3) { text-align: left; overflow: hidden; text-overflow: ellipsis; }

            /* Dividers */
            .part-ref { border-left: 1px solid #94a3b8 !important; background: #fff !important; }
            .part-both { border-left: 1px solid #94a3b8 !important; background: #fff !important; }
            
            /* Padding for simple TDs */
            .schedule-table td:first-child, .schedule-table td:nth-child(2) {
                padding: 2px 4px !important;
            }
            .matrix-table td {
                padding: 2px 4px !important;
            }

            /* VS Badge */
            .vs-badge {
                font-size: 0.6rem;
                font-weight: 900;
                color: #fff !important;
                background: #f97316 !important; 
                border-radius: 50%;
                width: 16px; height: 16px;
                display: inline-flex; 
                align-items: center; justify-content: center;
                line-height: 1;
                margin: 0 4px;
            }

            /* --- Matrix Colorful Symbols --- */
            .matrix-container { margin-top: 5px !important; border: none !important; }
            
            .symbol-game { background: #f97316 !important; color: #fff !important; border: none !important; font-weight: 800; padding: 1px 6px; border-radius: 4px; }
            .symbol-ref { background: #3b82f6 !important; color: #fff !important; border: none !important; font-weight: 800; padding: 1px 6px; border-radius: 4px; }
            .symbol-both { background: #a855f7 !important; color: #fff !important; border: none !important; font-weight: 800; padding: 1px 6px; border-radius: 4px; }
            
            h4 { 
                margin: 8px 0 4px 0 !important; 
                font-size: 0.95rem !important; 
                font-weight: 900; 
                text-transform: uppercase;
                color: #1e293b !important;
                border-left: 6px solid #f97316; 
                padding-left: 8px;
            }
            .matrix-legend { margin: 2px 0; font-size: 0.7rem; }

            .note-box {
                display: block !important;
                border: 2px solid #cbd5e1 !important;
                border-radius: 4px;
                margin-top: 8px; padding: 6px;
                font-size: 0.8rem;
                min-height: 2em;
                background: #f8fafc !important;
            }
            
            tr { break-inside: avoid; }
        }
    </style>
</head>
<body>

<header>
    <div class="container header-content">
        <div class="app-title">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8.56 2.75c4.37 6.03 6.02 9.42 8.03 17.72m2.54-5.38c-3.72-1.1-8.99-1.57-13.98.66m15.75-4.27c-3.72-2.77-9.87-1.79-15.63.28"></path></svg>
            GAME DAY SCHEDULER
        </div>
        <button class="btn-print" onclick="window.print()">
            <svg viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
            Print Schedule
        </button>
    </div>
</header>

<div class="container main-content">
    <!-- Settings Panel -->
    <div class="settings-panel">
        <div class="card">
            <div class="card-header">
                <svg class="icon-orange" viewBox="0 0 24 24"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>
                å¤§ä¼šãƒ»ä¼šå ´æƒ…å ±
            </div>
            <div class="row">
                <div class="col"><label>å¤§ä¼šå</label><input type="text" id="eventTitle" value="ç·´ç¿’è©¦åˆ"></div>
            </div>
            <div class="row">
                <div class="col"><label>ä¼šå ´</label><input type="text" id="eventVenue" value="å¸‚æ°‘ä½“è‚²é¤¨"></div>
            </div>
            <div class="row">
                <div class="col"><label>æ—¥ä»˜</label><input type="date" id="eventDate"></div>
                <div class="col"><label>é–‹å ´</label><input type="time" id="eventOpenTime" value="08:30"></div>
            </div>
            <div class="row">
                <div class="col"><label>é€£çµ¡äº‹é …</label><textarea id="eventNotes" rows="3" placeholder="é§è»Šå ´ã‚„æ³¨æ„äº‹é …ãªã©"></textarea></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <svg class="icon-orange" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                å‚åŠ ãƒãƒ¼ãƒ  (<span id="teamCount">0</span>)
            </div>
            <div id="teamsListContainer"></div>
            <button class="btn-outline mt-4" onclick="addTeam()">
                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> ãƒãƒ¼ãƒ è¿½åŠ 
            </button>
        </div>

        <div class="card">
            <div class="card-header">
                <svg class="icon-orange" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                è©¦åˆè¨­å®š
            </div>
            <label>å¯¾æˆ¦æ–¹å¼</label>
            <div class="tab-switch">
                <div class="tab-btn active" id="modeRoundRobin" onclick="setMatchType('round-robin')">ç·å½“ãŸã‚Š</div>
                <div class="tab-btn" id="modeFixed" onclick="setMatchType('fixed-count')">è©¦åˆæ•°æŒ‡å®š</div>
            </div>
            <div id="matchesPerTeamRow" class="row hidden">
                <div class="col"><input type="number" id="matchesPerTeam" value="2" min="1"></div>
            </div>
            <hr style="border:0; border-top:1px solid #e2e8f0; margin: 16px 0;">
            <label>æ™‚é–“ç®¡ç†</label>
            <div class="tab-switch">
                <div class="tab-btn active" id="timeAuto" onclick="setTimeMode('auto')">è‡ªå‹•è¨ˆç®—</div>
                <div class="tab-btn" id="timeFixed" onclick="setTimeMode('fixed')">å›ºå®šæ (â—¯åˆ†å›ã—)</div>
            </div>
            <div class="row">
                <div class="col"><label>ç¬¬1è©¦åˆ</label><input type="time" id="startTime" value="09:00"></div>
                <div class="col"><label>ã‚³ãƒ¼ãƒˆæ•°</label><input type="number" id="courts" value="2" min="1" max="10"></div>
            </div>
            <div id="autoTimeSettings"><div class="row"><div class="col"><label>è©¦åˆ(åˆ†)</label><input type="number" id="gameDuration" value="10"></div><div class="col"><label>ä¼‘æ†©(åˆ†)</label><input type="number" id="interval" value="5"></div></div></div>
            <div id="fixedTimeSettings" class="hidden"><div class="row"><div class="col"><label>æ (åˆ†)</label><input type="number" id="slotMinutes" value="20"></div></div></div>
            <hr style="border:0; border-top:1px solid #e2e8f0; margin: 16px 0;">
            <div class="row" style="align-items:flex-start;">
                <input type="checkbox" id="autoAssignOfficials" checked style="width:auto; margin-top:4px; margin-right:8px;">
                <div><label for="autoAssignOfficials" style="margin:0; cursor:pointer;">å¯©åˆ¤ãƒ»TOè‡ªå‹•å‰²ã‚Šå½“ã¦</label><div style="font-size:0.75rem; color:var(--text-sub);">å¯©åˆ¤2ãƒãƒ¼ãƒ ã€TOå…¼ä»»</div></div>
            </div>
            <button class="btn-primary mt-4" onclick="generateSchedule()">
                <svg viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg> ä½œæˆ
            </button>
        </div>
    </div>

    <!-- Preview Panel -->
    <div class="preview-panel">
        <div id="emptyState" class="empty-state">
            <svg class="icon-lg" style="color:#cbd5e1;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8.56 2.75c4.37 6.03 6.02 9.42 8.03 17.72m2.54-5.38c-3.72-1.1-8.99-1.57-13.98.66m15.75-4.27c-3.72-2.77-9.87-1.79-15.63.28"></path></svg>
            <p>å¯¾æˆ¦è¡¨ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>

        <div id="scheduleResult" class="card hidden">
            <div class="preview-header">
                <h1 id="printTitle">å¤§ä¼šå</h1>
                <div><span id="printDate"></span> <span id="printOpenTime"></span> <span id="printVenue"></span></div>
            </div>

            <div id="statsBar" class="no-print"></div>

            <div style="overflow-x:auto;">
                <table class="schedule-table" id="scheduleTable">
                    <thead id="scheduleHead"></thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>

            <div style="margin-top:8px;">
                 <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:4px;">
                     <h4 style="margin:0;">ãƒãƒ¼ãƒ å½¹å‰²åˆ†æ‹…è¡¨</h4>
                     <div class="matrix-legend">
                         <div class="legend-item"><span class="symbol-game">G</span> è©¦åˆ</div>
                         <div class="legend-item"><span class="symbol-both">â˜…</span> å¯©+TO</div>
                         <div class="legend-item"><span class="symbol-ref">R</span> å¯©åˆ¤</div>
                     </div>
                 </div>
                 <div id="teamDutyMatrix" class="matrix-container"></div>
            </div>

            <div id="teamOpponentList" class="no-print" style="margin-top:20px;"></div>

            <div id="printNotesContainer" class="hidden note-box">
                <h4 style="margin:0 0 2px 0;">é€£çµ¡äº‹é …</h4>
                <div id="printNotesContent" style="white-space: pre-wrap;"></div>
            </div>

            <div id="assignmentStats" class="no-print" style="margin-top:20px;"></div>
        </div>
    </div>
</div>

<script>
    const state = {
        teams: [{ id: 1, name: 'ãƒãƒ¼ãƒ A' }, { id: 2, name: 'ãƒãƒ¼ãƒ B' }, { id: 3, name: 'ãƒãƒ¼ãƒ C' }, { id: 4, name: 'ãƒãƒ¼ãƒ D' }, { id: 5, name: 'ãƒãƒ¼ãƒ E' }],
        matchType: 'round-robin',
        timeMode: 'auto',
        schedule: [],
        stats: {}
    };

    const els = {
        teamsList: document.getElementById('teamsListContainer'),
        teamCount: document.getElementById('teamCount'),
        matchesPerTeamRow: document.getElementById('matchesPerTeamRow'),
        autoTimeSettings: document.getElementById('autoTimeSettings'),
        fixedTimeSettings: document.getElementById('fixedTimeSettings'),
        emptyState: document.getElementById('emptyState'),
        scheduleResult: document.getElementById('scheduleResult'),
        scheduleHead: document.getElementById('scheduleHead'),
        scheduleBody: document.getElementById('scheduleBody'),
        teamDutyMatrix: document.getElementById('teamDutyMatrix'),
        eventDate: document.getElementById('eventDate'),
        matchesPerTeam: document.getElementById('matchesPerTeam'),
        gameDuration: document.getElementById('gameDuration')
    };

    els.eventDate.valueAsDate = new Date();

    function resolveTeamName(id) {
        if (id === null || id === 0) return "ãƒ¼";
        if (id === -1) return "è¦èª¿æ•´";
        const team = state.teams.find(t => t.id === id);
        return team ? team.name : "";
    }

    function renderTeams() {
        els.teamsList.innerHTML = '';
        state.teams.forEach((team, index) => {
            const div = document.createElement('div');
            div.className = 'team-item';
            div.innerHTML = `
                <div class="team-num">${index + 1}</div>
                <input type="text" value="${team.name}" oninput="updateTeamName(${team.id}, this.value)">
                <button class="btn-icon" onclick="removeTeam(${team.id})" ${state.teams.length <= 2 ? 'disabled' : ''}>
                    <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            `;
            els.teamsList.appendChild(div);
        });
        els.teamCount.textContent = state.teams.length;
    }

    function addTeam() {
        const newId = state.teams.length > 0 ? Math.max(...state.teams.map(t => t.id)) + 1 : 1;
        state.teams.push({ id: newId, name: `ãƒãƒ¼ãƒ ${String.fromCharCode(65 + state.teams.length)}` });
        renderTeams();
        if (state.schedule.length > 0) {
            const courts = parseInt(document.getElementById('courts').value) || 1;
            renderSchedule(courts);
        }
    }

    function removeTeam(id) {
        if (state.teams.length <= 2) return;
        state.teams = state.teams.filter(t => t.id !== id);
        renderTeams();
    }

    function updateTeamName(id, name) {
        const team = state.teams.find(t => t.id === id);
        if (team) {
            team.name = name;
            if (state.schedule.length > 0) {
                const courts = parseInt(document.getElementById('courts').value) || 1;
                renderSchedule(courts);
            }
        }
    }

    function setMatchType(type) {
        state.matchType = type;
        document.getElementById('modeRoundRobin').className = `tab-btn ${type === 'round-robin' ? 'active' : ''}`;
        document.getElementById('modeFixed').className = `tab-btn ${type === 'fixed-count' ? 'active' : ''}`;
        els.matchesPerTeamRow.className = type === 'fixed-count' ? 'row' : 'row hidden';
    }

    function setTimeMode(mode) {
        state.timeMode = mode;
        document.getElementById('timeAuto').className = `tab-btn ${mode === 'auto' ? 'active' : ''}`;
        document.getElementById('timeFixed').className = `tab-btn ${mode === 'fixed' ? 'active' : ''}`;
        els.autoTimeSettings.className = mode === 'auto' ? '' : 'hidden';
        els.fixedTimeSettings.className = mode === 'fixed' ? '' : 'hidden';
    }

    function generateSchedule() {
        const teams = state.teams;
        if (teams.length < 2) { alert("2ãƒãƒ¼ãƒ ä»¥ä¸Šå¿…è¦ã§ã™"); return; }

        const courts = parseInt(document.getElementById('courts').value) || 1;
        const startTimeStr = document.getElementById('startTime').value || "09:00";
        const gameDuration = parseInt(document.getElementById('gameDuration').value) || 10;
        const interval = parseInt(document.getElementById('interval').value) || 5;
        const slotMinutes = parseInt(document.getElementById('slotMinutes').value) || 20;
        const autoAssign = document.getElementById('autoAssignOfficials').checked;
        const matchesPerTeamVal = parseInt(els.matchesPerTeam.value) || 2;

        let activeTeams = [...teams];
        if (activeTeams.length % 2 !== 0) activeTeams.push(null);
        
        const n = activeTeams.length;
        const maxRounds = n - 1;
        let targetRounds = state.matchType === 'round-robin' ? maxRounds : matchesPerTeamVal;
        if (targetRounds > maxRounds) targetRounds = maxRounds;
        if (targetRounds < 1) targetRounds = 1;

        // --- Phase 1: è©¦åˆçµ„ã¿åˆã‚ã›ãƒ—ãƒ¼ãƒ«ä½œæˆ ---
        let roundTeams = [...activeTeams];
        const allMatchesPool = [];

        for (let r = 0; r < targetRounds; r++) {
            for (let i = 0; i < n / 2; i++) {
                const home = roundTeams[i];
                const away = roundTeams[n - 1 - i];
                if (home && away) {
                    allMatchesPool.push({ home: home, away: away, id: `M${r}-${i}` });
                }
            }
            // Rotate
            roundTeams.splice(1, 0, roundTeams.pop());
        }

        // --- Phase 2: é€£æˆ¦å›é¿ãƒ»2è©¦åˆç©ºãç¢ºä¿ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ---
        let bestSchedule = null;
        let bestMetrics = {
            doubleHeaders: Infinity,
            teamsWithoutLongBreak: Infinity,
            intervalVariance: Infinity
        };

        const ATTEMPTS = 200; // è©¦è¡Œå›æ•°

        for (let attempt = 0; attempt < ATTEMPTS; attempt++) {
            const shuffledPool = [...allMatchesPool].sort(() => Math.random() - 0.5);
            const result = tryBuildSchedule(shuffledPool, courts, teams, startTimeStr, gameDuration, interval, slotMinutes, state.timeMode);
            
            // è©•ä¾¡æ¯”è¼ƒ
            // å„ªå…ˆé †ä½ 1: é€£æˆ¦æ•° (å°‘ãªã„æ–¹ãŒè‰¯ã„)
            if (result.metrics.doubleHeaders < bestMetrics.doubleHeaders) {
                bestSchedule = result.schedule;
                bestMetrics = result.metrics;
            } else if (result.metrics.doubleHeaders === bestMetrics.doubleHeaders) {
                // å„ªå…ˆé †ä½ 3: å°‘ãªãã¨ã‚‚1å›ã¯2è©¦åˆç©ºããŒã‚ã‚‹ã‹ (ã€Œãªã„ã€ãƒãƒ¼ãƒ æ•°ãŒå°‘ãªã„æ–¹ãŒè‰¯ã„)
                if (result.metrics.teamsWithoutLongBreak < bestMetrics.teamsWithoutLongBreak) {
                    bestSchedule = result.schedule;
                    bestMetrics = result.metrics;
                } else if (result.metrics.teamsWithoutLongBreak === bestMetrics.teamsWithoutLongBreak) {
                    // å„ªå…ˆé †ä½ã®è£œè¶³: è©¦åˆé–“éš”ã®ã°ã‚‰ã¤ããŒå°ã•ã„æ–¹ãŒå…¬å¹³
                    if (result.metrics.intervalVariance < bestMetrics.intervalVariance) {
                        bestSchedule = result.schedule;
                        bestMetrics = result.metrics;
                    }
                }
            }
        }

        // --- Phase 3: å¯©åˆ¤å‰²ã‚Šå½“ã¦ (å…¬å¹³åŒ–ãƒ»ç§»å‹•è€ƒæ…®) ---
        const finalSchedule = assignOfficialsToSchedule(bestSchedule, teams, autoAssign);

        // é›†è¨ˆ
        const matchCounts = {};
        const refCounts = {};
        const toCounts = {};
        teams.forEach(t => { matchCounts[t.id] = 0; refCounts[t.id] = 0; toCounts[t.id] = 0; });
        finalSchedule.forEach(m => { 
            matchCounts[m.homeId]++; 
            matchCounts[m.awayId]++; 
            if(m.refIds) m.refIds.forEach(rid => { if(rid && rid > 0) refCounts[rid]++; });
            if(m.toId && m.toId > 0) toCounts[m.toId]++;
        });
        
        state.schedule = finalSchedule;
        state.stats = { total: finalSchedule.length, matchCounts, refCounts, toCounts };
        renderSchedule(courts);
    }

    // --- å†…éƒ¨é–¢æ•°: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹ç¯‰è©¦è¡Œ ---
    function tryBuildSchedule(pool, courts, teams, startTimeStr, gameDuration, interval, slotMinutes, timeMode) {
        const schedule = [];
        const poolCopy = [...pool];
        let currentTime = new Date(`2000-01-01T${startTimeStr}:00`);
        
        let doubleHeadersCount = 0;
        
        // å„ãƒãƒ¼ãƒ ã®è©¦åˆã‚¹ãƒ­ãƒƒãƒˆå±¥æ­´
        const playedSlots = {}; 
        teams.forEach(t => playedSlots[t.id] = []);

        let currentSlotIndex = 0;

        while (poolCopy.length > 0) {
            const timeStr = currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const slotBusyTeams = new Set();
            const slotMatches = [];

            for (let c = 0; c < courts; c++) {
                if (poolCopy.length === 0) break;

                // å€™è£œã‚’æ¢ã™
                // å„ªå…ˆåº¦1: ã“ã®æ™‚é–“æ ã§è©¦åˆã—ã¦ã„ãªã„ & ç›´å‰ã‚‚è©¦åˆã—ã¦ã„ãªã„ (é€£æˆ¦ãªã—)
                // å„ªå…ˆåº¦2: ã“ã®æ™‚é–“æ ã§è©¦åˆã—ã¦ã„ãªã„ (é€£æˆ¦ã‚ã‚Š)
                
                let bestIdx = -1;
                
                // 1. å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ãªå€™è£œã‚’æ¢ã™
                for (let i = 0; i < poolCopy.length; i++) {
                    const m = poolCopy[i];
                    if (!slotBusyTeams.has(m.home.id) && !slotBusyTeams.has(m.away.id)) {
                        const homeLast = playedSlots[m.home.id].length > 0 ? playedSlots[m.home.id][playedSlots[m.home.id].length-1] : -10;
                        const awayLast = playedSlots[m.away.id].length > 0 ? playedSlots[m.away.id][playedSlots[m.away.id].length-1] : -10;
                        
                        if (homeLast !== currentSlotIndex - 1 && awayLast !== currentSlotIndex - 1) {
                            bestIdx = i;
                            break; 
                        }
                    }
                }

                // 2. ãªã‘ã‚Œã°ã€ã‚„ã‚€ã‚’å¾—ãšé€£æˆ¦ã«ãªã‚‹å€™è£œã‚’æ¢ã™
                if (bestIdx === -1) {
                    for (let i = 0; i < poolCopy.length; i++) {
                        const m = poolCopy[i];
                        if (!slotBusyTeams.has(m.home.id) && !slotBusyTeams.has(m.away.id)) {
                            bestIdx = i;
                            doubleHeadersCount++; 
                            break;
                        }
                    }
                }

                if (bestIdx !== -1) {
                    const match = poolCopy.splice(bestIdx, 1)[0];
                    slotMatches.push({
                        ...match,
                        court: c + 1,
                        slotIndex: currentSlotIndex,
                        homeId: match.home.id,
                        awayId: match.away.id
                    });
                    slotBusyTeams.add(match.home.id);
                    slotBusyTeams.add(match.away.id);
                }
            }

            // ã‚³ãƒ¼ãƒˆèª¿æ•´ (1è©¦åˆãªã‚‰Bã‚³ãƒ¼ãƒˆã¸ç§»å‹•...ã®ã‚ˆã†ãªç¾çš„å‡¦ç†ã¯ä¸€æ—¦çœç•¥ã—ã€è©°ã‚ã¦é…ç½®)
            // ã‚‚ã—ç¾è¦³é‡è¦–ãªã‚‰ã“ã“ã§ slotMatches[0].court = 2 ãªã©ã‚’æ¤œè¨

            slotMatches.forEach(m => {
                playedSlots[m.homeId].push(currentSlotIndex);
                playedSlots[m.awayId].push(currentSlotIndex);
                schedule.push({ ...m, time: timeStr });
            });

            const addMinutes = timeMode === 'fixed' ? slotMinutes : (gameDuration + interval);
            currentTime.setMinutes(currentTime.getMinutes() + addMinutes);
            currentSlotIndex++;
        }

        // --- ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆç®— ---
        
        // 1. ã€Œ2è©¦åˆä»¥ä¸Šã®ç©ºãã€ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        // å·®åˆ†ãŒ3ä»¥ä¸Š (ä¾‹: ã‚¹ãƒ­ãƒƒãƒˆ1ã§è©¦åˆã€æ¬¡ã¯ã‚¹ãƒ­ãƒƒãƒˆ4ä»¥é™) ãªã‚‰ã€Œ2è©¦åˆç©ºãã€é”æˆ
        let teamsWithoutLongBreak = 0;
        let intervalSum = 0;
        let intervalCount = 0;
        let intervals = [];

        teams.forEach(t => {
            const slots = playedSlots[t.id];
            let hasLongBreak = false;
            
            if (slots.length < 2) {
                // è©¦åˆæ•°ãŒå°‘ãªã™ãã¦ä¼‘æ†©åˆ¤å®šã§ããªã„å ´åˆã¯OKæ‰±ã„ã¨ã™ã‚‹ã‹NGã¨ã™ã‚‹ã‹ã€‚
                // ã“ã“ã§ã¯ã€Œä¼‘æ†©ãŒå¿…è¦ãªã»ã©è©¦åˆã—ã¦ã„ãªã„ã€ã®ã§OKæ‰±ã„(=Breakã‚ã‚Š)ã¨ã™ã‚‹
                hasLongBreak = true; 
            } else {
                for (let i = 0; i < slots.length - 1; i++) {
                    const diff = slots[i+1] - slots[i];
                    intervals.push(diff);
                    if (diff >= 3) { // å·®ãŒ3ãªã‚‰ã€é–“ã«2ã¤ã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚‹
                        hasLongBreak = true;
                    }
                }
            }
            if (!hasLongBreak) teamsWithoutLongBreak++;
        });

        // åˆ†æ•£è¨ˆç®— (å…¬å¹³æ€§)
        const mean = intervals.length > 0 ? intervals.reduce((a,b)=>a+b,0)/intervals.length : 0;
        const variance = intervals.length > 0 ? intervals.reduce((a,b)=>a + Math.pow(b-mean, 2), 0) / intervals.length : 0;

        return { 
            schedule, 
            metrics: {
                doubleHeaders: doubleHeadersCount,
                teamsWithoutLongBreak: teamsWithoutLongBreak,
                intervalVariance: variance
            }
        };
    }

    // --- å†…éƒ¨é–¢æ•°: å¯©åˆ¤å‰²ã‚Šå½“ã¦ (å„ªå…ˆé †ä½ 2: å®Œå…¨å¹³å‡åŒ– & 4: ç§»å‹•è€ƒæ…®) ---
    function assignOfficialsToSchedule(schedule, teams, autoAssign) {
        if (!autoAssign) {
            return schedule.map(m => ({ ...m, refIds: [null, null], toId: null }));
        }

        const dutyCounts = {}; // Ref + TO count (å‚è€ƒç”¨)
        const refCounts = {};  // å¯©åˆ¤å›æ•° (æœ€é‡è¦)
        const toCounts = {};   // TOå›æ•°
        
        teams.forEach(t => { 
            dutyCounts[t.id] = 0; 
            refCounts[t.id] = 0; 
            toCounts[t.id] = 0; 
        });

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ™‚é–“æ ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const slotsMap = {};
        schedule.forEach(m => {
            if (!slotsMap[m.slotIndex]) slotsMap[m.slotIndex] = [];
            slotsMap[m.slotIndex].push(m);
        });

        const sortedSlots = Object.keys(slotsMap).sort((a,b) => parseInt(a) - parseInt(b));
        const enrichedMatches = [];

        sortedSlots.forEach(slotKey => {
            const slotIndex = parseInt(slotKey);
            const currentMatches = slotsMap[slotKey];
            
            // ã“ã®æ™‚é–“å¸¯ã«è©¦åˆãŒã‚ã‚‹ãƒãƒ¼ãƒ  (å‰²ã‚Šå½“ã¦ä¸å¯)
            const playingTeamIds = new Set();
            currentMatches.forEach(m => { playingTeamIds.add(m.homeId); playingTeamIds.add(m.awayId); });

            // ã“ã®æ™‚é–“å¸¯ã§ã™ã§ã«å¯©åˆ¤ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒãƒ¼ãƒ 
            const assignedInSlot = new Set();

            // è©¦åˆã”ã¨ã«å‰²ã‚Šå½“ã¦
            currentMatches.forEach(match => {
                // å€™è£œãƒãƒ¼ãƒ æŠ½å‡º
                let candidates = teams.filter(t => 
                    !playingTeamIds.has(t.id) && !assignedInSlot.has(t.id)
                );

                if (candidates.length < 1) {
                    enrichedMatches.push({ ...match, refIds: [-1, -1], toId: -1 });
                    return;
                }

                // ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆ
                // å„ªå…ˆé †ä½:
                // 1. å¯©åˆ¤å›æ•° (å°‘ãªã„æ–¹ãŒçµ¶å¯¾)
                // 2. ç§»å‹•è² æ‹… (åŒã˜ã‚³ãƒ¼ãƒˆã§ã®æ¥ç¶šãŒè‰¯ã„æ–¹ãŒè‰¯ã„)
                // 3. TOå›æ•° (å°‘ãªã„æ–¹ãŒè‰¯ã„)

                const scoredCandidates = candidates.map(team => {
                    let moveScore = 0;

                    // ç§»å‹•è² æ‹…ã®è©•ä¾¡
                    const prevSlotMatches = slotsMap[slotIndex - 1] || [];
                    const nextSlotMatches = slotsMap[slotIndex + 1] || [];

                    // ç›´å‰ãƒ»ç›´å¾Œã®çŠ¶æ³ãƒã‚§ãƒƒã‚¯
                    const playedPrevHere = prevSlotMatches.some(m => m.court === match.court && (m.homeId === team.id || m.awayId === team.id));
                    const willPlayNextHere = nextSlotMatches.some(m => m.court === match.court && (m.homeId === team.id || m.awayId === team.id));
                    
                    // ç§»å‹•ãªã—ï¼ˆåŒã˜ã‚³ãƒ¼ãƒˆã§é€£ç¶šï¼‰ãªã‚‰åŠ ç‚¹
                    if (playedPrevHere) moveScore += 1;
                    if (willPlayNextHere) moveScore += 1;
                    
                    // é•ã†ã‚³ãƒ¼ãƒˆãªã‚‰å¾®æ¸›ç‚¹ï¼ˆç§»å‹•ã®æ‰‹é–“ï¼‰
                    // ã“ã“ã¯ã€Œå¹³å‡åŒ–ã€ã‚’é˜»å®³ã—ãªã„ç¯„å›²ã§ã€åŒå›æ•°ã®æ™‚ã®æ±ºå®šæ‰“ã«ã™ã‚‹
                    
                    return { team, moveScore };
                });

                scoredCandidates.sort((a, b) => {
                    // 1. å¯©åˆ¤å›æ•° (æ˜‡é †) - çµ¶å¯¾å„ªå…ˆ
                    const refDiff = refCounts[a.team.id] - refCounts[b.team.id];
                    if (refDiff !== 0) return refDiff;

                    // 2. ç§»å‹•ã‚¹ã‚³ã‚¢ (é™é †) - å›æ•°ãŒåŒã˜ãªã‚‰ç§»å‹•ãŒæ¥½ãªæ–¹ã‚’é¸ã¶
                    const moveDiff = b.moveScore - a.moveScore;
                    if (moveDiff !== 0) return moveDiff;

                    // 3. TOå›æ•° (æ˜‡é †) - ãã‚Œã‚‚åŒã˜ãªã‚‰TOãŒå°‘ãªã„æ–¹
                    return toCounts[a.team.id] - toCounts[b.team.id];
                });

                // ä¸Šä½2ãƒãƒ¼ãƒ ã‚’é¸å‡º
                let assignedTeams = [];
                if (scoredCandidates.length >= 2) {
                    assignedTeams = [scoredCandidates[0].team, scoredCandidates[1].team];
                } else {
                    assignedTeams = [scoredCandidates[0].team];
                }

                // è¨˜éŒ²æ›´æ–°
                assignedTeams.forEach(t => {
                    assignedInSlot.add(t.id);
                    refCounts[t.id]++;
                    dutyCounts[t.id]++;
                });

                // TOå‰²ã‚Šå½“ã¦ (2ãƒãƒ¼ãƒ ã®ã†ã¡TOå›æ•°ãŒå°‘ãªã„æ–¹)
                let t1 = assignedTeams[0];
                let t2 = assignedTeams[1];
                let toId = null;

                if (t2) {
                    if (toCounts[t1.id] <= toCounts[t2.id]) {
                        toId = t1.id;
                        toCounts[t1.id]++;
                        dutyCounts[t1.id]++;
                    } else {
                        toId = t2.id;
                        toCounts[t2.id]++;
                        dutyCounts[t2.id]++;
                    }
                    enrichedMatches.push({ ...match, refIds: [t1.id, t2.id], toId: toId });
                } else {
                    // 1ãƒãƒ¼ãƒ ã®ã¿
                    toId = t1.id;
                    toCounts[t1.id]++;
                    dutyCounts[t1.id]++;
                    enrichedMatches.push({ ...match, refIds: [t1.id, -1], toId: toId });
                }
            });
        });

        return enrichedMatches.sort((a, b) => {
            if (a.slotIndex !== b.slotIndex) return a.slotIndex - b.slotIndex;
            return a.court - b.court;
        });
    }

    function renderSchedule(courts) {
        els.emptyState.classList.add('hidden');
        els.scheduleResult.classList.remove('hidden');
        
        let style = document.getElementById('dynamic-page-size');
        if (!style) { style = document.createElement('style'); style.id = 'dynamic-page-size'; document.head.appendChild(style); }
        style.innerHTML = `@media print { @page { size: portrait; } }`; 

        document.getElementById('printTitle').textContent = document.getElementById('eventTitle').value;
        document.getElementById('printVenue').textContent = 'ğŸ“ ' + document.getElementById('eventVenue').value;
        const d = new Date(document.getElementById('eventDate').value);
        if(!isNaN(d)) document.getElementById('printDate').textContent = 'ğŸ“… ' + d.toLocaleDateString();
        document.getElementById('printOpenTime').textContent = 'â° ' + document.getElementById('eventOpenTime').value + " é–‹å ´";

        const notes = document.getElementById('eventNotes').value;
        document.getElementById('printNotesContainer').classList.remove('hidden');
        document.getElementById('printNotesContent').textContent = notes;

        const timeSlots = {};
        state.schedule.forEach(match => {
            if (!timeSlots[match.time]) timeSlots[match.time] = [];
            timeSlots[match.time].push(match);
        });

        // Header
        let theadHtml = `<tr><th style="width:30px">No.</th><th style="width:50px">æ™‚é–“</th>`;
        for (let c = 1; c <= courts; c++) {
            const courtName = courts > 1 ? `ã‚³ãƒ¼ãƒˆ${String.fromCharCode(64 + c)}` : 'è©¦åˆå†…å®¹';
            theadHtml += `<th>
                <div class="header-inner">
                    <div class="header-part header-title-box">
                        <span class="court-label">${courtName}</span>
                        <span class="court-sub">çµ„ã¿åˆã‚ã›</span>
                    </div>
                    <div class="header-part header-border-left">å¯©</div>
                    <div class="header-part header-border-left" style="font-size:0.75rem; letter-spacing:-1px;">å¯©+TO</div>
                </div>
            </th>`;
        }
        theadHtml += `</tr>`;
        els.scheduleHead.innerHTML = theadHtml;

        els.scheduleBody.innerHTML = '';
        let slotIndex = 1;

        for (const [time, matches] of Object.entries(timeSlots)) {
            const tr = document.createElement('tr');
            tr.innerHTML += `<td class="text-center" style="font-family:monospace;">${slotIndex}</td>`;
            tr.innerHTML += `<td style="font-weight:bold;">${time}</td>`;

            for (let c = 1; c <= courts; c++) {
                const match = matches.find(m => m.court === c);
                if (match) {
                    
                    const homeName = resolveTeamName(match.homeId);
                    const awayName = resolveTeamName(match.awayId);
                    const r1Name = resolveTeamName(match.refIds[0]);
                    const r2Name = resolveTeamName(match.refIds[1]);
                    const toName = resolveTeamName(match.toId);

                    let refOnly = "";
                    let refTo = "";
                    
                    if (match.refIds.length >= 2) {
                        const r1Id = match.refIds[0];
                        const r2Id = match.refIds[1];
                        
                        // ã©ã¡ã‚‰ãŒTOå…¼ä»»ã‹åˆ¤å®šã—ã¦è¡¨ç¤º
                        if (r1Id !== null && r1Id !== -1 && r1Id === match.toId) {
                            refTo = r1Name; refOnly = r2Name;
                        } else if (r2Id !== null && r2Id !== -1 && r2Id === match.toId) {
                            refTo = r2Name; refOnly = r1Name;
                        } else {
                            // é€šå¸¸ã“ã“ã«ã¯æ¥ãªã„ãŒå¿µã®ãŸã‚
                            refOnly = [r1Name, r2Name].filter(n => n !== "ãƒ¼").join(",");
                            refTo = toName + (match.toId !== null && match.toId !== -1 ? "(TOã®ã¿)" : "");
                        }
                        
                        if(match.toId === -1) refTo = "è¦èª¿æ•´";
                        if(match.toId === null) refTo = "ãƒ¼";

                    } else if (match.refIds.length === 2 && match.refIds[1] === -1) {
                         // 1ãƒãƒ¼ãƒ ã—ã‹ã„ãªã„å ´åˆ
                         refTo = r1Name;
                         refOnly = "ãƒ¼";
                    } else {
                        refOnly = "ãƒ¼"; refTo = "ãƒ¼";
                    }

                    tr.innerHTML += `
                        <td>
                            <div class="match-cell">
                                <div class="cell-part part-teams">
                                    <span>${homeName}</span>
                                    <span class="vs-badge">vs</span>
                                    <span>${awayName}</span>
                                </div>
                                <div class="cell-part part-ref">
                                    <span>${refOnly}</span>
                                </div>
                                <div class="cell-part part-both">
                                    <span>${refTo}</span>
                                </div>
                            </div>
                        </td>
                    `;
                } else {
                    tr.innerHTML += `<td style="background:#f8fafc;"></td>`;
                }
            }
            els.scheduleBody.appendChild(tr);
            slotIndex++;
        }

        // Matrix
        const times = Object.keys(timeSlots);
        let matrixHtml = `<table class="matrix-table"><thead><tr><th class="matrix-team-col">ãƒãƒ¼ãƒ </th>`;
        times.forEach((t, i) => { matrixHtml += `<th>${i + 1}</th>`; });
        matrixHtml += `</tr></thead><tbody>`;

        state.teams.forEach(team => {
            matrixHtml += `<tr><td class="matrix-team-col">${team.name}</td>`;
            times.forEach(time => {
                let symbol = ""; let className = "";
                const slotMatches = timeSlots[time] || [];
                for (const m of slotMatches) {
                    if (m.homeId === team.id || m.awayId === team.id) { symbol = "G"; className = "symbol-game"; break; }
                    
                    let isRef = m.refIds && m.refIds.includes(team.id); 
                    let isTo = m.toId === team.id;
                    
                    if (isRef && isTo) { symbol = "â˜…"; className = "symbol-both"; break; }
                    else if (isRef) { symbol = "R"; className = "symbol-ref"; }
                    else if (isTo) { symbol = "TO"; className = "symbol-ref"; }
                }
                matrixHtml += `<td>${symbol ? `<span class="${className}">${symbol}</span>` : ''}</td>`;
            });
            matrixHtml += `</tr>`;
        });
        matrixHtml += `</tbody></table>`;
        els.teamDutyMatrix.innerHTML = matrixHtml;

        // Opponents
        const opponentsMap = {};
        state.teams.forEach(t => opponentsMap[t.id] = []);
        state.schedule.forEach(m => { 
            if (opponentsMap[m.homeId]) opponentsMap[m.homeId].push(resolveTeamName(m.awayId)); 
            if (opponentsMap[m.awayId]) opponentsMap[m.awayId].push(resolveTeamName(m.homeId)); 
        });
        let opponentHtml = `<table class="matrix-table"><thead><tr><th class="matrix-team-col" style="width:150px;">ãƒãƒ¼ãƒ </th><th>å¯¾æˆ¦ç›¸æ‰‹ (è©¦åˆé †)</th></tr></thead><tbody>`;
        state.teams.forEach(t => {
            const oppsStr = opponentsMap[t.id].length > 0 ? opponentsMap[t.id].join(' â–¶ ') : 'ãªã—';
            opponentHtml += `<tr><td class="matrix-team-col">${t.name}</td><td style="text-align:left;">${oppsStr}</td></tr>`;
        });
        opponentHtml += `</tbody></table>`;
        document.getElementById('teamOpponentList').innerHTML = opponentHtml;

        // Stats Footer
        const statsContainer = document.getElementById('assignmentStats');
        statsContainer.innerHTML = '';
        state.teams.forEach(t => {
            const div = document.createElement('div');
            div.style.background = '#f1f5f9'; div.style.padding = '4px 8px'; div.style.borderRadius = '4px';
            div.innerHTML = `<div>${t.name}</div><div style="font-size:0.75rem;">è©¦:${state.stats.matchCounts[t.id]} å¯©:${state.stats.refCounts[t.id]} TO:${state.stats.toCounts[t.id]}</div>`;
            statsContainer.appendChild(div);
        });
    }

    renderTeams();
</script>
</body>
</html>